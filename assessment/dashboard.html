<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CMMC Assessment Dashboard — TANO Research</title>
  <link rel="stylesheet" href="../styles.css" />

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .stat-card {
      padding: 0.75rem 1rem;
      background: #111;
      border-radius: 8px;
      border: 1px solid #333;
    }
    .stat-label {
      font-size: 0.85rem;
      color: #aaa;
    }
    .stat-value {
      font-size: 1.4rem;
      font-weight: bold;
    }
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    .chart-container {
      background: #111;
      border-radius: 8px;
      border: 1px solid #333;
      padding: 0.75rem;
      min-height: 260px;
    }
    .chart-container h3 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    .chart-container canvas {
      width: 100%;
      height: 210px;
    }
    .filter-row {
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .filter-row select {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #111;
      color: #fff;
    }
    .table-wrapper {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #333;
      border-radius: 8px;
      background: #111;
      margin-top: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e1e1e;
      color: #fff;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border: 1px solid #333;
      vertical-align: top;
    }
    th {
      background: #333;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tr:nth-child(even) {
      background: #252525;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
      border: 1px solid #555;
    }
    .badge-l1 { background: #203040; }
    .badge-l2 { background: #402030; }
    .badge-status-impl { background: #1f4f2b; }
    .badge-status-not { background: #5a2020; }
    .badge-status-na { background: #444422; }
    .badge-status-none { background: #333333; }
  </style>
</head>
<body>

<!-- Top navigation, matching your existing style -->
<div style="margin:1rem 0;">
  <a href="index.html" class="btn-primary">← Assessment Home</a>
  &nbsp;|&nbsp;
  <a href="../cmmc.html" class="btn-primary">← CMMC Center</a>
  &nbsp;|&nbsp;
  <a href="../index.html" class="btn-primary">← TANO Home</a>
</div>

<div class="card">
  <h1>CMMC Assessment Dashboard</h1>
  <p>
    This dashboard summarizes your current CMMC Level 1 and Level 2 assessment
    progress. Data comes from your browser’s local storage
    (<code>tano_L1_assessment</code> and <code>tano_L2_assessment</code>).
  </p>

  <!-- View filter -->
  <div class="filter-row">
    <label for="viewMode"><strong>View controls for:</strong></label>
    &nbsp;
    <select id="viewMode">
      <option value="all">All Controls (L1 + L2)</option>
      <option value="L1">Level 1 Only</option>
      <option value="L2">Level 2 Only</option>
    </select>
  </div>

  <!-- Overall stats -->
  <h2>Overall Assessment Status</h2>
  <div id="overallStats" class="stat-grid"></div>

  <!-- Level-by-level stats -->
  <h2>Level Breakdown</h2>
  <div id="levelsStats" class="stat-grid"></div>

  <!-- Charts -->
  <h2>Visual Overview</h2>
  <div class="chart-grid">
    <div class="chart-container">
      <h3>Completion Breakdown (Current View)</h3>
      <canvas id="completionDonut"></canvas>
    </div>
    <div class="chart-container">
      <h3>Implemented Controls by Level</h3>
      <canvas id="levelBar"></canvas>
    </div>
    <div class="chart-container">
      <h3>Domain Maturity (Current View)</h3>
      <canvas id="domainRadar"></canvas>
    </div>
  </div>

  <!-- Incomplete controls -->
  <h2 style="margin-top:1.75rem;">Incomplete Controls</h2>
  <p style="font-size:0.9rem;">
    Listed below are all controls in the current view that are
    <strong>Not Implemented</strong> or <strong>Not Yet Assessed</strong>.
  </p>

  <button class="btn-primary" onclick="downloadIncompleteCSV()">
    Download Incomplete Controls CSV
  </button>

  <div class="table-wrapper">
    <table id="incompleteTable">
      <thead>
        <tr>
          <th>Level</th>
          <th>Practice ID</th>
          <th>Domain</th>
          <th>Practice Name</th>
          <th>Status</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<footer>© TANO Research — Exploring Possibilities with Integrity Everywhere</footer>

<script>
const L1_CSV = "https://ochoa104cy.github.io/TANO-Research/cmmc-playbook/controls/L1_Practices.csv";
const L2_CSV = "https://ochoa104cy.github.io/TANO-Research/cmmc-playbook/controls/L2_Practices.csv";

let allRecords = [];   // all L1+L2 controls + assessment
let completionChart, levelChart, radarChart;

function loadLocalState(key) {
  const raw = localStorage.getItem(key);
  if (!raw) return {};
  try { return JSON.parse(raw); } catch (e) { return {}; }
}

function parseCSV(text) {
  return text
    .split(/\r?\n/)
    .filter(line => line.trim() !== "")
    .map(line => {
      const parts = [];
      let cur = "";
      let inQuotes = false;
      for (let i=0; i<line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (ch === ',' && !inQuotes) {
          parts.push(cur);
          cur = "";
        } else {
          cur += ch;
        }
      }
      parts.push(cur);
      return parts.map(p => p.replace(/^"|"$/g, ""));
    });
}

function buildRecords(l1Rows, l2Rows) {
  const l1State = loadLocalState("tano_L1_assessment");
  const l2State = loadLocalState("tano_L2_assessment");
  const records = [];

  function process(rows, level, state) {
    const header = rows[0];
    const idx = {
      id: header.indexOf("Practice ID"),
      domain: header.indexOf("Domain"),
      name: header.indexOf("Practice Name"),
      desc: header.indexOf("Description")
    };
    for (let i=1; i<rows.length; i++) {
      const r = rows[i];
      const id = r[idx.id];
      if (!id) continue;
      const st = state[id] || { status: "", notes: "" };
      records.push({
        level,
        id,
        domain: r[idx.domain] || "",
        name: r[idx.name] || "",
        desc: r[idx.desc] || "",
        status: st.status || "",
        notes: st.notes || ""
      });
    }
  }

  process(l1Rows, "L1", l1State);
  process(l2Rows, "L2", l2State);
  allRecords = records;
}

function filterByViewMode(records, mode) {
  if (mode === "L1") return records.filter(r => r.level === "L1");
  if (mode === "L2") return records.filter(r => r.level === "L2");
  return records;
}

function computeStats(records) {
  let total = records.length;
  let impl = 0, notImpl = 0, na = 0, none = 0;
  records.forEach(r => {
    if (r.status === "Implemented") impl++;
    else if (r.status === "Not Implemented") notImpl++;
    else if (r.status === "N/A") na++;
    else none++;
  });
  const pct = total > 0 ? Math.round((impl / total) * 100) : 0;
  return { total, impl, notImpl, na, none, pct };
}

function computeDomainMaturity(records) {
  const map = {};
  records.forEach(r => {
    const d = r.domain || "Unspecified";
    if (!map[d]) map[d] = { total: 0, impl: 0 };
    map[d].total++;
    if (r.status === "Implemented") map[d].impl++;
  });
  const domains = Object.keys(map).sort();
  const values = domains.map(d => {
    const x = map[d];
    return x.total > 0 ? Math.round((x.impl / x.total) * 100) : 0;
  });
  return { domains, values };
}

function renderOverallStats(viewRecords) {
  const overallEl = document.getElementById("overallStats");
  const allStats = computeStats(allRecords);
  const viewStats = computeStats(viewRecords);

  overallEl.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">All Levels — Total Controls</div>
      <div class="stat-value">${allStats.total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">All Levels — Implemented</div>
      <div class="stat-value">${allStats.impl}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">All Levels — Completion %</div>
      <div class="stat-value">${allStats.pct}%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Current View — Controls</div>
      <div class="stat-value">${viewStats.total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Current View — Completion %</div>
      <div class="stat-value">${viewStats.pct}%</div>
    </div>
  `;
}

function renderLevelStats() {
  const levelsEl = document.getElementById("levelsStats");
  const l1 = allRecords.filter(r => r.level === "L1");
  const l2 = allRecords.filter(r => r.level === "L2");
  const s1 = computeStats(l1);
  const s2 = computeStats(l2);

  levelsEl.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Level 1 — Controls</div>
      <div class="stat-value">${s1.total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Level 1 — Implemented</div>
      <div class="stat-value">${s1.impl}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Level 1 — Completion %</div>
      <div class="stat-value">${s1.pct}%</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">Level 2 — Controls</div>
      <div class="stat-value">${s2.total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Level 2 — Implemented</div>
      <div class="stat-value">${s2.impl}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Level 2 — Completion %</div>
      <div class="stat-value">${s2.pct}%</div>
    </div>
  `;
}

/* --------- Charts --------- */

function initCharts() {
  const donutCtx = document.getElementById("completionDonut").getContext("2d");
  const barCtx   = document.getElementById("levelBar").getContext("2d");
  const radarCtx = document.getElementById("domainRadar").getContext("2d");

  completionChart = new Chart(donutCtx, {
    type: "doughnut",
    data: {
      labels: ["Implemented", "Not Implemented", "N/A", "Not Assessed"],
      datasets: [{ data: [0,0,0,0] }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  levelChart = new Chart(barCtx, {
    type: "bar",
    data: {
      labels: ["Level 1", "Level 2"],
      datasets: [{
        label: "Implemented Controls",
        data: [0, 0]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    }
  });

  radarChart = new Chart(radarCtx, {
    type: "radar",
    data: {
      labels: [],
      datasets: [{
        label: "Domain Maturity (%)",
        data: []
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } }
    }
  });
}

function updateCharts(viewRecords) {
  const statsView = computeStats(viewRecords);

  completionChart.data.datasets[0].data = [
    statsView.impl,
    statsView.notImpl,
    statsView.na,
    statsView.none
  ];
  completionChart.update();

  const l1 = allRecords.filter(r => r.level === "L1");
  const l2 = allRecords.filter(r => r.level === "L2");
  const s1 = computeStats(l1);
  const s2 = computeStats(l2);

  levelChart.data.datasets[0].data = [s1.impl, s2.impl];
  levelChart.update();

  const dom = computeDomainMaturity(viewRecords);
  radarChart.data.labels = dom.domains;
  radarChart.data.datasets[0].data = dom.values;
  radarChart.update();
}

/* --------- Incomplete table + CSV --------- */

function getIncomplete(records) {
  return records.filter(r => r.status !== "Implemented");
}

function renderIncompleteTable(viewRecords) {
  const tbody = document.querySelector("#incompleteTable tbody");
  tbody.innerHTML = "";
  const incomplete = getIncomplete(viewRecords);

  incomplete.forEach(r => {
    const statusLabel =
      r.status === "Implemented" ? "Implemented" :
      r.status === "Not Implemented" ? "Not Implemented" :
      r.status === "N/A" ? "N/A" :
      "Not Assessed";

    const statusClass =
      r.status === "Implemented" ? "badge-status-impl" :
      r.status === "Not Implemented" ? "badge-status-not" :
      r.status === "N/A" ? "badge-status-na" :
      "badge-status-none";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="badge ${r.level === "L1" ? "badge-l1" : "badge-l2"}">${r.level}</span></td>
      <td>${r.id}</td>
      <td>${r.domain}</td>
      <td>${r.name}</td>
      <td><span class="badge ${statusClass}">${statusLabel}</span></td>
      <td>${r.notes ? r.notes : "<span style='color:#777;'>None</span>"}</td>
    `;
    tbody.appendChild(tr);
  });
}

function downloadIncompleteCSV() {
  const mode = document.getElementById("viewMode").value;
  const viewRecords = filterByViewMode(allRecords, mode);
  const incomplete = getIncomplete(viewRecords);

  let csv = "Level,Practice ID,Domain,Practice Name,Status,Notes\n";
  incomplete.forEach(r => {
    const status =
      r.status === "Implemented" ? "Implemented" :
      r.status === "Not Implemented" ? "Not Implemented" :
      r.status === "N/A" ? "N/A" :
      "Not Assessed";

    const row = [
      r.level,
      r.id,
      r.domain,
      r.name,
      status,
      (r.notes || "").replace(/"/g, '""')
    ].map(v => `"${v}"`).join(",");
    csv += row + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "TANO_CMMC_Incomplete_Controls.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* --------- Main init + refresh --------- */

function refreshDashboard() {
  const mode = document.getElementById("viewMode").value;
  const viewRecords = filterByViewMode(allRecords, mode);

  renderOverallStats(viewRecords);
  renderLevelStats();
  updateCharts(viewRecords);
  renderIncompleteTable(viewRecords);
}

document.getElementById("viewMode").addEventListener("change", refreshDashboard);

Promise.all([fetch(L1_CSV), fetch(L2_CSV)])
  .then(([r1, r2]) => Promise.all([r1.text(), r2.text()]))
  .then(([t1, t2]) => {
    const l1Rows = parseCSV(t1);
    const l2Rows = parseCSV(t2);
    buildRecords(l1Rows, l2Rows);
    initCharts();
    refreshDashboard();
  })
  .catch(err => {
    console.error("Error loading CSVs for dashboard:", err);
  });
</script>

</body>
</html>
